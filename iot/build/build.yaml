name: $(BuildID)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - "iot/*"
      - "shared/*"

stages:
  - stage: Build
    jobs:
      - job: Restore
        displayName: "DotNet Restore"
        steps:
          - task: DotNetCoreCLI@1
            displayName: Run dotnet restore
            inputs:
              command: "restore"
              projects: "iot/src/**/*.csproj"
      - job: Build
        displayName: "DotNet Build"
        dependsOn: Restore
        steps:
          - task: DotNetCoreCLI@1
            displayName: Run dotnet build
            inputs:
              projects: "iot/src/**/*.csproj"
  - stage: Publish
    jobs:
      - job: DotNetPublish
        displayName: "DotNet Publish"
        steps:
          - task: DotNetCoreCLI@1
            displayName: Run dotnet publish
            inputs:
              command: "publish"
              publishWebProjects: "False"
              projects: "iot/src/**/*.csproj"
              arguments: "--output $(build.artifactstagingdirectory)"
              zipAfterPublish: "True"
      - job: "PublishFunctions"
        displayName: "Publish Functions"
        dependsOn: DotNetPublish
        steps:
          - task: PublishBuildArtifacts@1
            displayName: Publish Azure Functions
            inputs:
              pathToPublish: $(build.artifactstagingdirectory)
              artifactName: functions
              artifactType: container
      - job: "PublishDeployFolder"
        displayName: "Publish Deploy Artifacts"
        steps:
          - task: PublishBuildArtifacts@1
            displayName: Publish Deployment Scripts
            inputs:
              pathToPublish: iot/deploy
              artifactName: deploy
              artifactType: container
