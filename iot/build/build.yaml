name: $(BuildID)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - "iot/*"
      - "shared/*"

stages:
  - stage: "Build"
    jobs:
      - job: "Restore"
        steps:
          - task: DotNetCoreCLI@1
            displayName: Run dotnet restore
            inputs:
              command: "restore"
              projects: "iot/src/**/*.csproj"
      - job: "Build"
        steps:
          - task: DotNetCoreCLI@1
            displayName: Run dotnet build
            inputs:
              projects: "iot/src/**/*.csproj"
  - stage: "Publish"
    jobs:
      - job: "DotNet Publish"
        steps:
          - task: DotNetCoreCLI@1
            displayName: Run dotnet publish
            inputs:
              command: "publish"
              publishWebProjects: "False"
              projects: "iot/src/**/*.csproj"
              arguments: "--output $(build.artifactstagingdirectory)"
              zipAfterPublish: "True"
      - job: "Publish Functions as Artifacts"
        steps:
          - task: PublishBuildArtifacts@1
            displayName: Publish Azure Functions
            inputs:
              pathToPublish: $(build.artifactstagingdirectory)
              artifactName: functions
              artifactType: container
      - job: "Publish Deploy Folder"
        steps:
          - task: PublishBuildArtifacts@1
            displayName: Publish Deployment Scripts
            inputs:
              pathToPublish: iot/deploy
              artifactName: deploy
              artifactType: container
