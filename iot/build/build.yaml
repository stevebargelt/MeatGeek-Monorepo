name: $(BuildID)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - "iot/*"
      - "shared/*"

stages:
  - stage: Build
    jobs:
      - job: Build
        displayName: "DotNet Restore"
        steps:
          - task: DotNetCoreCLI@1
            displayName: Run dotnet restore
            inputs:
              command: "restore"
              projects: "iot/src/**/*.csproj"
          - task: DotNetCoreCLI@1
            displayName: Run dotnet build
            inputs:
              projects: "iot/src/**/*.csproj"
  - stage: Publish
    jobs:
      - job: DotNetPublish
        displayName: "DotNet Publish"
        steps:
          - task: DotNetCoreCLI@1
            displayName: Run dotnet publish
            inputs:
              command: "publish"
              publishWebProjects: "False"
              projects: "iot/src/**/*.csproj"
              arguments: "--output $(build.artifactstagingdirectory)"
              zipAfterPublish: "True"
          - publish: $(build.artifactstagingdirectory)
            artifact: functions
      - job: PublishDeployFolder
        displayName: "Publish Deploy Artifacts"
        steps:
          - task: PublishBuildArtifacts@1
            displayName: Publish Deployment Scripts
            inputs:
              pathToPublish: iot/deploy
              artifactName: deploy
              artifactType: container
      - deployment: deployprod
        displayName: Deploy to Prod
        dependsoOn: DotNetPublish
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  inputs:
                    buildType: "current"
                    artifactName: "functions"
                    targetPath: "$(System.DefaultWorkingDirectory)"
                - task: AzureRmWebAppDeployment@4
                  displayName: Azure Functions Deploy
                  inputs:
                    ConnectionType: "AzureRM"
                    azureSubscription: "Visual Studio Enterprise"
                    ResourceGroupName: "MeatGeek-IoT"
                    appType: functionApp
                    package: "$(System.DefaultWorkingDirectory)/functions/MeatGeek.IoT.Functions.zip"
                    webAppName: "meatgeek-iot-app-service-plan"
# $(System.DefaultWorkingDirectory)/_stevebargelt.MeatGeek-IoT/functions/MeatGeek.IoT.Functions.zip
